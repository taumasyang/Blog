---
title: 删除重复文件
date: 2022-11-09 10:55:20
categories: 技术分享
tags: Shell
---

百度网盘对于超大文件夹的下载非常不友好。事实上，它自己也不知道需要下载哪些文件，所以当它认为它已经全部下载完成的时候，我们仍旧对此持怀疑态度。因此，保险起见，笔者对于相同的大文件夹又点了一次下载。令笔者大跌眼镜的是，百度网盘对于本地已经存在的文件并不会跳过，而是选择再下载一份，然后重命名为 `filename(1).ext`。对此笔者非常不满，但是仍需要来收拾这烂摊子。

我们的需求是：
- 找出所有文件名以 `(1)` 结尾的文件；
- 验证其原始文件是否存在；
- 如果原始文件存在，删除重复文件。

## 去重脚本

```sh
path="."
oldIFS=$IFS
IFS=$'\n'
for file in `find $path -name "*(1).*" -type f -print`
do
  if [ -e $file ]; then
    filed=`echo $file | sed 's/(1)././g'`
    if [ -e $filed ]; then
    rm $file
    fi
  fi
done
IFS=$oldIFS
```

### 查找文件

查找文件用 `find` 命令。我们需要指定文件名以 `(1)` 结尾，文件类型是普通文件，并将结果打印出来。
```sh
find . -name "*(1).*" -type f -print
```

### 判断文件是否存在

判断文件用 `[ -e filename ]`。如果文件存在，则返回 `1`，否则返回 `0`。

### 处理文件名

原始文件的文件名不包含 `(1)`，我们使用 `sed` 将文件名中的 `(1)` 去掉。

`sed` 的基本语法是 `sed 's/old/new/g' filename`，其中三个斜杠中间的内容就是要替换的字符串和替换后的字符串。
```sh
filed=`echo $file | sed 's/(1)././g'`
```
{% note info %}
这里使用管道传递文件名而不是将其作为参数跟在 `sed` 命令后面的原因是后者会直接对文件内容进行处理而不是文件名本身。
{% endnote %}

### 删除文件

删除文件使用简单的 `rm` 命令即可。如果希望看到删除了什么文件，只需加上 `-v` 开关。

{% note warning %}
`rm` 命令将永久移除文件。如果只希望将文件移到废纸篓，请使用 `trash` 命令。`trash` 命令不是 macOS 系统命令，需要使用 `brew install trash` 来安装它。
{% endnote %}

### 临时替换 IFS

脚本中将 IFS 临时替换为 `'\n'` 的原因在于，如果文件名包含空格，`for` 会将其分开处理，导致这类文件的重复项不会被删除。

## 泛用性

上述脚本的查重规则可以修改。例如，iCloud 云盘会将重复项的文件名添加 `" 2"`，那么将 `find` 命令 `-name` 参数改成 `"*\ 2.*"`即可。

对于不依赖文件名而关注文件 hash 的查重，在 Linux 上有一些实现方法，但是在 macOS 上不可用，且暂时没有找到替代方案。